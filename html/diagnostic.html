<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
        <input type="button" onclick="diagnostic()" value="Diagnostic">
        <p id="diagnostic"></p>
    </body>
    <script src="/js/general.js"></script>
    <script>
        async function diagnostic() {
            let temps_limite = 10;
            let intervalle = setInterval(() => {
                window.alert(`Veuillez scanner la carte du livre à diagnostiquer (il vous reste ${--temps_limite}s)`)
                if (temps_limite == 0) {
                    clearInterval(intervalle);
                    window.alert("Temps écoulé, veuillez réinitier la procédure");
                }
            }, 1000);

            const res = await api_uid_nfc();
            if (res.code > 0) {
                clearInterval(intervalle);
                const requete_livre = await api_livres();
                if (requete_livre.code > 0) {
                    const index = requete_livre.val.uid_nfc.indexOf(res.val);
                    if (index !== -1) {
                        const res_hist = await api_hist_livre(index + 1); // Les ID commencent à 1
                        if (res_hist.code > 0) {
                            const sortie = document.getElementById("diagnostic");
                            sortie = `Informations sur le livre<br/>
                                <ul>
                                    <li>ID: ${res_hist.val.id_l[0]}</li>
                                    <li>Titre: ${res_hist.val.titre[0]}</li>
                                    <li>Genre: ${res_hist.val.genre[0]}</li>
                                    <li>Rayon: ${res_hist.val.rayon[0]}</li>
                                    <li>Date de parution: ${res_hist.val.date_parution[0]}</li>
                                    <li>UID NFC: ${res_hist.val.uid_nfc[0]}</li>
                                    <li>Chemin d'image: ${res_hist.val.chemin_image[0]}</li>
                                </ul>
                                Historique:<br/>`;
                            for (let i = 0; i < res_hist.val.id_l.length; i++) {
                                sortie.innerHTML += `Emprunt ${i + 1}<br/>
                                    <ul>
                                        <li>Date Debut: ${res_hist.val.date_debut[0]}</li>
                                        <li>Date Fin: ${res_hist.val.date_fin[0]}</li>
                                        <li>Rendu?: ${res_hist.val.rendu[0] ? "Oui" : "Non"}</li>
                                    </ul><br/>`;
                            }
                        } else {
                            window.alert(G_CODE_ERREURS[res_hist.code])
                        }
                    } else {
                        window.alert("Carte de livre inconnue");
                    }
                } else {
                    window.alert(G_CODE_ERREURS[requete_livre.code])
                }
            } else {
                window.alert(G_CODE_ERREURS[res.code])
            }
        }
    </script>
</html>