<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <link rel="stylesheet" href="/css/recherche.css">
    </head>
    <body>
        <header>
        	<a href="/html/accueil.html" class="logo">ESC</a>
        	<div class="group">
          		<ul class="navigation">
            		<li><a onclick="emprunter()">Emprunter</a></li>
            		<li><a onclick="retour()">Rendre</a></li>
            		<li><a href="/html/desinscription.html">Désinscription</a></li>
            		<li><a onclick="deconnexion()">Déconnection</a></li>
          		</ul>
				<div class="search">
					<span class="icon">
					<ion-icon name="search-outline" class="searchBtn"></ion-icon>
					<ion-icon name="close-outline" class="closeBtn"></ion-icon>
					</span>
				</div>
        	</div>
        	<div class="searchBox">
          		<input type="text" id="valeurs" placeholder="rechercher . . .">
        	</div>
      	</header>
        <div class="left-info">
            <h2 id="titre-gauche">Cliquez et scannez pour identifier une carte:</h2>
            <div class="card">
                <div class="texte">
                    <input type="button" onclick="identifier()" value="Identifier"><br>
                    <p id="compteur"></p>
                </div>
            </div>
            <div id="res_ident"></div>
        </div>
        <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
        <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
        <script src="/js/general.js"></script>
		<script src="/js/navbar.js"></script>
        <script>
            async function identifier() {
                const tag_compteur = document.getElementById("compteur");
                let temps_limite = 10;
                let intervalle = setInterval(() => {
                    tag_compteur.innerHTML
                        = `Veuillez scanner la carte à identifier (il vous reste ${--temps_limite}s)`;
                    if (temps_limite == 0) {
                        clearInterval(intervalle);
                        tag_compteur.innerHTML = "Temps écoulé, veuillez réinitier la procédure";
                    }
                }, 1000);

                const res = await api_uid_nfc();
                clearInterval(intervalle);
                if (res.code > 0) {
                    const requete_livre = await api_livres();
                    if (requete_livre.code > 0) {
                        const index = requete_livre.val.uid_nfc.indexOf(res.val);
                        if (index !== -1) {
                            const res_hist = await api_hist_livre(index + 1); // Les ID commencent à 1
                            if (res_hist.code > 0) {
                                const sortie = document.getElementById("res_ident");
                                // Si n'a jamais été emprunté ou emprunté mais rendu
                                const disponible
                                    = (res_hist.val.rendu.length === 0 || res_hist.val.rendu[res_hist.val.rendu.length - 1] === 1);
                                sortie.innerHTML = `
                                    <div class="card">
                                        <img src="/upload/${requete_livre.val.nom_image[index]}">
                                        <div class="texte">
                                            <p>
                                                Titre : ${requete_livre.val.titre[index]}<br/>
                                                Genre: ${requete_livre.val.genre[index]}<br/>
                                                Rayon: ${requete_livre.val.rayon[index]}<br/>
                                                Date de Parution: ${requete_livre.val.date_parution[index]}<br/>
                                                Disponibilité: ${disponible}
                                            </p>
                                        </div>
                                    </div>`;
                            } else {
                                window.alert(G_CODE_ERREURS[res_hist.code]);
                            }
                        } else {
                            window.alert("Carte de livre inconnue");
                        }
                    } else {
                        window.alert(G_CODE_ERREURS[requete_livre.code])
                    }
                } else {
                    window.alert(G_CODE_ERREURS[res.code])
                }
            }
        </script>
    </body>
</html>