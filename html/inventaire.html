<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <link rel="stylesheet" href="/css/recherche.css">
    </head>
    <body>
        <header>
        	<a href="/html/accueil.html" class="logo">ESC</a>
        	<div class="group">
          		<ul class="navigation">
            		<li><a onclick="emprunter()">Emprunter</a></li>
            		<li><a onclick="retour()">Rendre</a></li>
            		<li><a href="/html/desinscription.html">Désinscription</a></li>
            		<li><a onclick="deconnexion()">Déconnection</a></li>
          		</ul>
				<div class="search">
					<span class="icon">
					<ion-icon name="search-outline" class="searchBtn"></ion-icon>
					<ion-icon name="close-outline" class="closeBtn"></ion-icon>
					</span>
				</div>
        	</div>
        	<div class="searchBox">
          		<input type="text" id="valeurs" placeholder="rechercher . . .">
        	</div>
      	</header>
        <div class="left-info">
            <h2 id="titre-gauche">Cliquez et scannez pour identifier une carte!:</h2>
            <div class="card">
                <div class="texte">
                    <input type="text" id="titre" placeholder="Titre" name="titre"><br/>
                    <input type="text" id="genre" placeholder="Genre" name="genre"><br/>
                    <input type="text" id="auteur" placeholder="Auteur" name="auteur"><br/>
                    <input type="text" id="editeur" placeholder="Editeur" name="editeur"><br/>
                    <input type="text" id="rayon" placeholder="Rayon" name="rayon"><br/>
                    <input type="date" id="date_parution" placeholder="Date de Parution" name="date_parution"><br/>
                    <input type="file" id="image_couverture" placeholder="Image de Couverture" name="image_couverture"><br/>
                    <input type="button" onclick="ajout_livre()" value="Ajout"><br/>
                    <input type="button" onclick="retrait_livre()" value="Retrait"><br/>
                    <p id="compteur"></p>
                </div>
            </div>
        </div>
        <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
        <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
        <script src="/js/general.js"></script>
		<script src="/js/navbar.js"></script>
        <script>
            async function ajout_livre() {
                const tag_titre         = document.getElementById("titre");
                const tag_genre         = document.getElementById("genre");
                const tag_auteur         = document.getElementById("auteur");
                const tag_editeur         = document.getElementById("editeur");
                const tag_rayon         = document.getElementById("rayon");
                const tag_parution      = document.getElementById("date_parution");
                const tag_couverture    = document.getElementById("image_couverture");
                const tag_compteur      = document.getElementById("compteur");

                let info = "";
                if (tag_titre.value.length < 1) {
                    info += "Vous devez spécifier le titre\n";
                }
                if (tag_genre.value.length < 1) {
                    info += "Vous devez spécifier le genre\n";
                }
                if (tag_auteur.value.length < 1) {
                    info += "Vous devez spécifier l'auteur\n";
                }
                if (tag_editeur.value.length < 1) {
                    info += "Vous devez spécifier l'éditeur\n";
                }
                if (tag_rayon.value.length < 1) {
                    info += "Vous devez spécifier le rayon\n";
                }
                if (tag_parution.value == "" || aujourdhui_yyyy_mm_dd() <= tag_parution.value) {
                    info += "Vous devez spécifier une date valide\n";
                }
                if (tag_couverture.files.length < 1) {
                    info += "Vous devez fournir une image de couverture\n";
                }
                if (info != "") {
                    window.alert(info);
                    return;
                }

                let temps_limite = 10;
                let intervalle = setInterval(() => {
                    tag_compteur.innerHTML
                        = `Veuillez scanner une carte LIBRE à associer au livre (il vous reste ${--temps_limite}s)`;
                    if (temps_limite == 0) {
                        clearInterval(intervalle);
                        tag_compteur.innerHTML = "Temps écoulé, veuillez réinitier la procédure";
                    }
                }, 1000);

                const res = await api_uid_nfc();
                if (res.code > 0) {
                    clearInterval(intervalle);
                    const image_couverture = tag_couverture.files[0];

                    const lecteur = new FileReader();
                    lecteur.onloadend = async function (event) {
                        const image_b64 = event.target.result.split(',')[1];
                        const res_ajout = await api_ajout(
                            tag_titre.value,
                            tag_genre.value,
                            tag_auteur.value,
                            tag_editeur.value,
                            tag_rayon.value,
                            tag_parution.value,
                            res.val,
                            image_couverture.name,
                            image_b64
                        );
                        window.alert(G_CODE_ERREURS[res_ajout.code])
                    };
                    lecteur.readAsDataURL(image_couverture);
                } else {
                    window.alert(G_CODE_ERREURS[res.code])
                }
            }

            async function retrait_livre() {
                const tag_compteur      = document.getElementById("compteur");

                let temps_limite = 10;
                let intervalle = setInterval(() => {
                    tag_compteur.innerHTML
                        = `Veuillez scanner la carte du livre à retirer de la circulation (il vous reste ${--temps_limite}s)`;
                    if (temps_limite == 0) {
                        clearInterval(intervalle);
                        tag_compteur.innerHTML = "Temps écoulé, veuillez réinitier la procédure";
                    }
                }, 1000);

                const res = await api_uid_nfc();
                if (res.code > 0) {
                    clearInterval(intervalle);
                    const requete_livre = await api_livres();
                    if (requete_livre.code > 0) {
                        const index = requete_livre.val.uid_nfc.indexOf(res.val);
                        if (index !== -1) {
                            const res_retrait = await api_retrait(requete_livre.val.id[index]);
                            window.alert(G_CODE_ERREURS[res_retrait.code])
                        } else {
                            window.alert("Carte de livre inconnue");
                        }
                    } else {
                        window.alert(G_CODE_ERREURS[requete_livre.code])
                    }
                } else {
                    window.alert(G_CODE_ERREURS[res.code])
                }
            }
        </script>
    </body>
</html>